<!DOCTYPE html>
<meta charset="utf-8">
<style>

svg {
  float: center;
  //border-bottom: solid 1px #ccc;
  //border-right: solid 1px #ccc;
  //margin-right: -1px;
  //margin-bottom: -1px;
}

.link.transition {
	fill: none;
	stroke: rgb(32,32,32);
	stroke-width: 3px;
}
.link2 {
	fill: none;
	stroke: rgb(32,32,32);
	stroke-width: 1px;
	//stroke-dasharray : 5,5;
}
	
.node > rect {
	fill : lightgray;
	stroke: gray;
	rx : 10;
	ry : 10;
}
	
.parameter > circle {
	stroke-width:1;
	stroke:rgb(32,32,32);
}

.state > rect {
	stroke-width:2px;
	stroke: rgb(32,32,32);
}
</style>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/scripts.js"></script>
<script>

var proto = {
	"id" : "ru.beeline.iot.gateway.zipato.proto.ZipatoAuthenticateProtocol",
	"exceptions" : [
		{
			"id" : "NullPointerException",
			"type" : "java.lang.NullPointerException"
		}
	],
	"inputs" : [
		{
			"id" : "login",
			"type" : "java.lang.String"
		},
		{
			"id" : "password",
			"type" : "java.lang.String"
		}
	],
	"outputs" : [
		{
			"id" : "success",
			"type" : "boolean"
		}
	],
	"states" : [
		{	
			"x" : 200,
			"y" : 200,
			"id" : "719b2a8a-4119-453b-a39d-62e9ce2d6cc6",
			"label" : "Create Bootstrap",
			"ref" : "ru.beeline.iot.gateway.zipato.CreateBootstrapBehaviour",
			"exceptions" : [
				{
					"id" : "NullPointerException",
					"type" : "java.lang.NullPointerException"
				}
			],
			"inputs" : [ 
				{
					"id" : "eventLoop",
					"label" : "Event Loop",
					"type" : "io.netty.channel.EventLoopGroup",
					"required" : true
				}, 
				{
					"id" : "channel",
					"type" : "java.lang.Class<? extends io.netty.channel.Channel>"
				}, 
				{
					"id" : "options",
					"type" : "java.util.Map<io.netty.channel.ChannelOption<java.lang.Object>, java.lang.Object>"
				}, 
				{
					"id" : "handler",
					"type" : "io.netty.channel.ChannelHandler"
				}
			],
			"outputs" : [ 
				{
					"id" : "bootstrap",
					"type" : "io.netty.bootstrap.Bootstrap"
				}
			]
		},
		{	
			"x" : 500,
			"y" : 100,
			"id" : "2da4cfe4-9da7-4940-830d-bbed1e895568",
			"label" : "Check Not Null",
			"ref" : "ru.beeline.iot.CheckNotNull",
			"inputs" : [ 
				{
					"id" : "input",
					"type" : "java.lang.Object",
					"required" : true
				}
			],
			"outputs" : [ 
				{
					"id" : "result",
					"type" : "boolean"
				}
			]
		},
		{	
			"x" : 600,
			"y" : 300,
			"id" : "test",
			"label" : "false",
			"ref" : "ru.beeline.iot.CheckNotNull",
			"inputs" : [ ],
			"outputs" : [ 
				{
					"id" : "result",
					"type" : "boolean"
				}
			]
		}
	],
	"dataflow" : [
		["login", "719b2a8a-4119-453b-a39d-62e9ce2d6cc6#eventLoop"],
		["login", "719b2a8a-4119-453b-a39d-62e9ce2d6cc6#options"],
		["login", "719b2a8a-4119-453b-a39d-62e9ce2d6cc6#channel"],
		["password", "719b2a8a-4119-453b-a39d-62e9ce2d6cc6#handler"],
		["719b2a8a-4119-453b-a39d-62e9ce2d6cc6#bootstrap", "2da4cfe4-9da7-4940-830d-bbed1e895568#input"],
		["2da4cfe4-9da7-4940-830d-bbed1e895568#result", "success"],
		["test#result", "success"]
	],
	"workflow" : [
		[null, "719b2a8a-4119-453b-a39d-62e9ce2d6cc6"], 
		["719b2a8a-4119-453b-a39d-62e9ce2d6cc6", "2da4cfe4-9da7-4940-830d-bbed1e895568"],
		["719b2a8a-4119-453b-a39d-62e9ce2d6cc6", "test"],
		["2da4cfe4-9da7-4940-830d-bbed1e895568", null],
		["test", null]
	]
}

var datalinks = [];

function findState2(arr, id){
	for(var i = 0; i < arr.length; i++){
		if(arr[i].id === id){
			return arr[i];
		}
	}
}

function parse(str){
	var split = str.split("#");
	var first = split[0];
	var second = split[1];
	if (!second){
		var param = findState2(proto.inputs, first);
		if(!param){
			var param = findState2(proto.outputs, first);
		}
		return param;
	} else {
		var state = findState2(proto.states, first);
		var param = findState2(state.inputs, second);
		if(!param){
			var param = findState2(state.outputs, second);
		}
		return param;
	}
}

proto.dataflow.forEach(function(d, i) {
	datalinks.push({source:parse(d[0]), target:parse(d[1])});
});

console.log(datalinks);

var width = 1200,
    height = 600,
    radius = 40;
	
var titleH = 40;
var paramH = 15;

var drag = d3.behavior.drag()
    .origin(function(d) { return d; })
	//.on("dragend", function(s){console.log(s);})
    .on("drag", dragmove);

var dragParam = d3.behavior.drag()
    .origin(function(d) { return d; })
    .on("drag", function(s){console.log(s);})
	//.on("dragend", function(s){console.log(s);})
    //.on("dragstart", dragstartParam)
	;
    //.on("dragend", function(s){console.log(s);});
	
/***********************************
 *		SVG
 ***********************************/
var svg = d3.select("body").append("div").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.append("defs").selectAll("marker")
    .data(["arrow"])
  .enter().append("marker")
    .attr("id", function(d) { return d; })
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 10)
    .attr("refY", 0)
    .attr("markerWidth", 6)
    .attr("markerHeight", 4)
    .attr("orient", "auto")
	.style("fill", "rgb(32,32,32)")
  .append("path")
    .attr("d", "M0,-5L10,0L0,5");

/***********************************
 *		NODE
 ***********************************/
var marginL = 100;
var marginT = 50;
var marginR = 100;
var marginB = 50;

var node = svg
	.selectAll("g.node")
		.data([proto]).enter()
	.append("g")
		.classed("node", true)
		.attr("transform", "translate(" + marginL + ", " + marginT + ")");
		
var nodeBody = node.append("rect")
	.attr("width", width - marginL - marginR)
	.attr("height", height - marginT - marginB);

function drawParameterCircle(param) {
	param.attr("r", 5)
		.style("fill", function(d) { return getTypeColor(d.type);})
		.attr("cursor", "pointer");
}
	
/***********************************
 *		NODE INPUTS
 ***********************************/
var inputs = node.append("g")
	.attr("transform", "translate(0, 80)");
	
var input = inputs.selectAll("g.input")
	.data(function(d){return d.inputs;})
	.enter()
	.append("g")
	.classed("input", true)
	.classed("parameter", true)
	.attr("transform", function(d, i){
		d.finishX = 0;
		d.finishY = 80 + i * 20; 
		return "translate(0, " + i * 20 + ")";
	});

	input.append("circle")
		.call(drawParameterCircle);

	input.append("text")
		.text(function(d){return d.id;})
		.attr("text-anchor", "end")
		.attr("alignment-baseline", "middle")
		.attr("transform", function(d, i){return "translate(-10, 0)";});

/***********************************
 *		NODE OUTPUTS
 ***********************************/
var outputs = node.append("g")
	.attr("transform", "translate(" + (width - marginL - marginR) + ", 80)");
	
var output = outputs.selectAll("g.output")
	.data(function(d){return d.outputs;})
	.enter()
	.append("g")
	.classed("output", true)
	.classed("parameter", true)
	.attr("transform", function(d, i){
		d.startX = width - marginL - marginR;
		d.startY = 80 + i * 20; 
		return "translate(0, " + i * 20 + ")";
	});

	output.append("circle")
		.call(drawParameterCircle);

	output.append("text")
		.text(function(d){return d.id;})
		.attr("text-anchor", "start")
		.attr("alignment-baseline", "middle")
		.attr("transform", function(d, i){return "translate(10, 0)";});

var inW = 100;

/***********************************
 *		START CIRCLE
 ***********************************/
var startCircleR = 10;
var finishCircleR = 15;
var circleOffset = 35;

function drawCircle(node){
	node.attr("r", startCircleR)
	.attr("cy", circleOffset)
	.style("fill", "rgb(32,32,32)");
}

node.append("circle")
	.call(drawCircle);

/***********************************
 *		FINISH CIRCLE
 ***********************************/
node.append("circle")
	.attr("r", finishCircleR)
	.style("fill", "lightgray")
	.style("stroke", "rgb(32,32,32)")
	.style("stroke-width", "2px")
	.attr("cx", width - marginL - marginR)
	.attr("cy", circleOffset);
	
node.append("circle")
	.call(drawCircle)
	.attr("cx", width - marginL - marginR);
	
/***********************************
 *		STATES
 ***********************************/
var g = node.selectAll("g.state").data(function(d){return proto.states;})
	.enter().append("g")
	.classed("state", true)
    .attr("x", function(d) { return d.x; })
    .attr("y", function(d) { return d.y; })
    .attr("cursor", "move")
	.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"})
    .call(drag);

var colors = d3.scale.category10()
	.domain([0, 1, 2, 3, 4, 5, 6, 7, 8, 9]);
	
function find(array, value) {
  for (var i = 0; i < array.length; i++) {
    if (array[i].id == value) return array[i];
  }
  return undefined;
}

var rect = g.append("rect")
    .attr("width", function(d) { return radius * 3; })
    .attr("height", function(d) {
		return d.inputs.length * paramH + titleH + d.outputs.length * paramH; })
    .style("fill", d3.hsl(colors(2)).brighter(1.1))
    .attr("rx", 10)
    .attr("ry", 10)
	.each(function(d){
		var parentTranslate = d3.transform(this.parentNode.getAttribute('transform')).translate;
		var x = parentTranslate[0];
		var y = parentTranslate[1];
		d.startX = x;
		d.startY = y + 15;
		d.finishX = x + parseFloat(this.getAttribute('width'));
		d.finishY = y + 15;
	});

/***********************************
 *		LINKS
 ***********************************/
var links = [];

function findState(id){
	for(var i = 0; i < proto.states.length; i++){
		if(proto.states[i].id === id){
			return proto.states[i];
		}
	}
}

proto.workflow.forEach(function(d, i) {
	var fromID = d[0];
	var toID = d[1];
	if(fromID != null){
		var from = findState(fromID);
	} else {
		var from = {finishX:10, finishY:35};
	}
	if(toID != null){
		var to = findState(toID);
	} else {
		var to = {startX:1000-15, startY:35};
	}
	links.push({source:from, target:to});
});

var diagonal = d3.svg.diagonal()
    .source(function(d) { return {"x":d.source.finishY, "y":d.source.finishX}; })            
    .target(function(d) { return {"x":d.target.startY, "y":d.target.startX}; })
    .projection(function(d) { return [d.y, d.x]; });

console.log(links);

var link = node.selectAll(".link")
        .data(links)
        .enter().append("path")
		.classed("transition", true)
		.classed("link", true)
        .attr("d", diagonal)
    .attr("marker-end", "url(#arrow)");
		
var text = g.append("text")
    .attr("width", function(d) { return radius * 3; })
    .attr("style", "fill:rgb(32,32,32);")
    .attr("font-weight", "bold")
    .attr("text-anchor", "middle")
    .attr("alignment-baseline", "baseline")
    .attr("x", radius * 3/ 2)
    .attr("y", radius / 2)
    .attr("text-overflow", "ellipsis")
    .text(function(d) { return d.label; });

var outputContainer = g.append("g")
	.attr("transform", function(d) { return "translate(0," + titleH + ")"});
	
var inputContainer = g.append("g")
	.attr("transform", 
	function(d) {
		return "translate(0, " + (d.outputs.length * paramH + titleH) + ")"}
	);	
var inputGroup = inputContainer
	.selectAll("g.input.parameter")
		.data(function(d) {return d.inputs; })
		.enter()
	.append("g")
		.classed("input parameter", true)
		.attr("transform", function(d, i) {
			var parentTranslateX = d3.transform(this.parentNode.getAttribute('transform')).translate[0];
			var parentTranslateY = d3.transform(this.parentNode.getAttribute('transform')).translate[1];
			var grandParentTranslateX = d3.transform(this.parentNode.parentNode.getAttribute('transform')).translate[0];
			var grandParentTranslateY = d3.transform(this.parentNode.parentNode.getAttribute('transform')).translate[1];
			d.startX = 0 + parentTranslateX + grandParentTranslateX;
			d.startY = (i * paramH) + parentTranslateY + grandParentTranslateY;
			return "translate(0," + (i * paramH) + ")";
		});

var outputGroup = outputContainer
	.selectAll("g.output.parameter")
		.data(function(d) { return d.outputs; })
		.enter()
	.append("g")
		.classed("output parameter", true)
		.attr("transform", function(d, i) { 
			var parentTranslateX = d3.transform(this.parentNode.getAttribute('transform')).translate[0];
			var parentTranslateY = d3.transform(this.parentNode.getAttribute('transform')).translate[1];
			var grandParentTranslateX = d3.transform(this.parentNode.parentNode.getAttribute('transform')).translate[0];
			var grandParentTranslateY = d3.transform(this.parentNode.parentNode.getAttribute('transform')).translate[1];
			d.finishX = (radius * 3) + parentTranslateX + grandParentTranslateX;
			d.finishY = (i * paramH) + parentTranslateY + grandParentTranslateY;
			return "translate(" + radius * 3 + "," + (i * paramH) + ")";
		});
	
var inputCircle = inputGroup.append("circle")
	.call(drawParameterCircle)
    .call(dragParam);
	
var inputText = inputGroup.append("text")
	.text(function(d) { return d.id; })
	.attr("x", 10)	
    .attr("text-anchor", "start")
    .attr("alignment-baseline", "middle")
	.attr("style", "font-size:12;");
	
var outputCircle = outputGroup.append("circle")
	.call(drawParameterCircle);

var outputText = outputGroup.append("text")
	.text(function(d) { return d.id; })
	.attr("x", -10)	
    .attr("text-anchor", "end ")
    .attr("alignment-baseline", "middle")
	.attr("style", "font-size:12;");


var link2 = node.selectAll(".link2")
        .data(datalinks)
        .enter().append("path")
		.classed("transition", true)
		.classed("link2", true)
        .attr("d", diagonal)
		.style("stroke", function(d) { return getTypeColor(d.source.type);})
    //.attr("marker-end", "url(#arrow)")
	;

var newLink = {};

function dragstartParam(d){
	console.log(d);
	newLink = node.select(".linkNew")
        .data([{source:{finishX : d.startX, finishY : d.startY}, target:{startX : d.startX, startY : d.startY}}])
        .enter().append("path")
		.classed("linkNew", true)
        .attr("d", diagonal)
		.style("stroke", function(d) { return getTypeColor(d.source.type);})
    //.attr("marker-end", "url(#arrow)")
	;
}

function dragmoveParam(d){
	console.log(d3.event);
	d3.event.stopPropagation();
}

function dragmove(d) {
            d3.event.sourceEvent.stopPropagation();
	var deltaX = d3.event.x - d.x;
	var deltaY = d3.event.y - d.y;
	
	d.x += d3.event.dx;
	d.y += d3.event.dy;
	d.startX += d3.event.dx;
	d.startY += d3.event.dy;
	d.finishX += d3.event.dx;
	d.finishY += d3.event.dy;
	
	d3.select(this)
		.attr("transform", "translate(" + d.x + "," + d.y + ")")
	
	d3.select(this).selectAll("g.output.parameter")
		.each(function(d){
			d.finishX += d3.event.dx;
			d.finishY += d3.event.dy;
		})
	
	d3.select(this).selectAll("g.input.parameter")
		.each(function(d){
			d.startX += d3.event.dx;
			d.startY += d3.event.dy;
		})
		
	
	
	link.attr("d", diagonal);
	link2.attr("d", diagonal);
}

	function zoom() {
		node.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
	}

    // define the zoomListener which calls the zoom function on the "zoom" event constrained within the scaleExtents
    var zoomListener = d3.behavior.zoom().scaleExtent([0.1, 3]).on("zoom", zoom);
//svg.call(zoomListener);
</script>