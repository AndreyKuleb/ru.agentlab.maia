<!DOCTYPE html>
<meta charset="utf-8">
<style>

svg {
  float: left;
  //border-bottom: solid 1px #ccc;
  //border-right: solid 1px #ccc;
  //margin-right: -1px;
  //margin-bottom: -1px;
}

</style>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script>

var tasks = [
{
	"id" : "ru.beeline.iot.CheckNotNull",
	"inputs" : [ 
		{
			"id" : "input",
			"type" : "java.lang.Object",
			"required" : true
		}
	],
	"outputs" : [ 
		{
			"id" : "result",
			"type" : "boolean"
		}
	]
},
{
	"id" : "ru.beeline.iot.gateway.zipato.CreateBootstrapBehaviour",
	"exceptions" : [
		{
			"id" : "NullPointerException",
			"type" : "java.lang.NullPointerException"
		}
	],
	"inputs" : [ 
		{
			"id" : "eventLoop",
			"label" : "Event Loop",
			"type" : "io.netty.channel.EventLoopGroup",
			"required" : true
		}, 
		{
			"id" : "channel",
			"type" : "java.lang.Class<? extends io.netty.channel.Channel>"
		}, 
		{
			"id" : "options",
			"type" : "java.util.Map<io.netty.channel.ChannelOption<java.lang.Object>, java.lang.Object>"
		}, 
		{
			"id" : "handler",
			"type" : "io.netty.channel.ChannelHandler"
		}
	],
	"outputs" : [ 
		{
			"id" : "bootstrap",
			"type" : "io.netty.bootstrap.Bootstrap"
		}
	]
}
]

var proto = {
	"id" : "ru.beeline.iot.gateway.zipato.proto.ZipatoAuthenticateProtocol",
	"exceptions" : [
		{
			"id" : "NullPointerException",
			"type" : "java.lang.NullPointerException"
		}
	],
	"inputs" : [
		{
			"id" : "login",
			"type" : "java.lang.String"
		},
		{
			"id" : "password",
			"type" : "java.lang.String"
		}
	],
	"outputs" : [
		{
			"id" : "success",
			"type" : "boolean"
		}
	],
	"states" : [
		{	
			"x" : 200,
			"y" : 200,
			"id" : "719b2a8a-4119-453b-a39d-62e9ce2d6cc6",
			"label" : "Create Bootstrap",
			"ref" : "ru.beeline.iot.gateway.zipato.CreateBootstrapBehaviour"
		},
		{	
			"x" : 500,
			"y" : 100,
			"id" : "2da4cfe4-9da7-4940-830d-bbed1e895568",
			"label" : "Check Not Null",
			"ref" : "ru.beeline.iot.CheckNotNull"
		}
	],
	"dataflow" : [
		["login@self", "eventLoop@719b2a8a-4119-453b-a39d-62e9ce2d6cc6"],
		["bootstrap@719b2a8a-4119-453b-a39d-62e9ce2d6cc6", "input@2da4cfe4-9da7-4940-830d-bbed1e895568"],
		["output@2da4cfe4-9da7-4940-830d-bbed1e895568", "success@self"]
	],
	"workflow" : [
		["self", "719b2a8a-4119-453b-a39d-62e9ce2d6cc6", "2da4cfe4-9da7-4940-830d-bbed1e895568", "self"],
		["NullPointerException@719b2a8a-4119-453b-a39d-62e9ce2d6cc6", "NullPointerException@self"]
	]
}
var dict = {};
var hues = [];


function getTypeColor(type) {
	var color = dict[type];
	
	if(typeof color != 'undefined'){
		return color;
	} else {
		var hue = Math.floor(Math.random()*360);
		if (dict.length <= 360 && hues.indexOf(hue) > 0){
			return getTypeColor(type);
		} else {
			hues.push(hue);
			color = d3.hsl(hue, 0.7, 0.4);
			dict[type] = color;
			return color;
		}
	}
}
 
var width = 1040,
    height = 525,
    radius = 40;
	
var titleH = 40;
var paramH = 15;

var drag = d3.behavior.drag()
    .origin(function(d) { return d; })
    .on("drag", dragmove);
	
var svg = d3.select("body").append("div").append("svg")
    .attr("width", width)
    .attr("height", height);

var marginL = 100;
var marginT = 50;
var marginR = 100;
var marginB = 50;

var node = svg
	.selectAll("g.node")
		.data([proto]).enter()
	.append("g")
		.classed("node", true)
		.attr("transform", "translate(" + marginL + ", " + marginT + ")");

node.append("rect")
	.attr("width", width - marginL - marginR)
	.attr("height", height - marginT - marginB)
	.style("fill", "none")
	.style("stroke", "lightgray")
    .attr("rx", 10)
    .attr("ry", 10);
	
var inputs = node.append("g")
	.classed("inputs", true)
	.attr("transform", "translate(0, 80)");
	
var input = inputs.selectAll(".input")
	.data(function(d){return d.inputs;})
	.enter()
	.append("g")
	.classed("input", true)
	.attr("transform", function(d, i){return "translate(0, " + i * 20 + ")";});

	input.append("circle")
		.attr("r", 5)
		.attr("style", function(d, i) { return "fill:" + d3.hsl(getTypeColor(d.type)).brighter(1.1) + ";stroke-width:1;stroke:rgb(32,32,32)";});;

	input.append("text")
		.text(function(d){return d.id;})
		.attr("text-anchor", "end")
		.attr("alignment-baseline", "middle")
		.attr("transform", function(d, i){return "translate(-10, 0)";});
	
var outputs = node.append("g")
	.classed("outputs", true)
	.attr("transform", "translate(" + (width - marginL - marginR) + ", 80)");
	
var output = outputs.selectAll(".output")
	.data(function(d){return d.outputs;})
	.enter()
	.append("g")
	.classed("output", true)
	.attr("transform", function(d, i){return "translate(0, " + i * 20 + ")";});

	output.append("circle")
		.attr("r", 5)
		.attr("style", function(d, i) { return "fill:" + d3.hsl(getTypeColor(d.type)).brighter(1.1) + ";stroke-width:1;stroke:rgb(32,32,32)";});;

	output.append("text")
		.text(function(d){return d.id;})
		.attr("text-anchor", "start")
		.attr("alignment-baseline", "middle")
		.attr("transform", function(d, i){return "translate(10, 0)";});

var inW = 100;

node.append("circle")
	.attr("r", 10)
	.attr("cy", 35);

node.append("circle")
	.attr("r", 15)
	.style("fill", "white")
	.style("stroke", "black")
	.attr("cx", width - marginL - marginR)
	.attr("cy", 35);
	
node.append("circle")
	.attr("r", 10)
	.attr("cx", width - marginL - marginR)
	.attr("cy", 35);

var g = node.selectAll(".state").data(function(d){return proto.states;})
	.enter().append("g")
	.attr("class", "state")
    .attr("x", function(d) { return d.x; })
    .attr("y", function(d) { return d.y; })
    .attr("cursor", "move")
	.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"})
    .call(drag);

var colors = d3.scale.category10()
	.domain([0, 1, 2, 3, 4, 5, 6, 7, 8, 9]);
	
function find(array, value) {
  for (var i = 0; i < array.length; i++) {
    if (array[i].id == value) return array[i];
  }
  return undefined;
}

var rect = g.append("rect")
    .attr("width", function(d) { return radius * 3; })
    .attr("height", function(d) { 
	var task = find(tasks, d.ref);
	return task.inputs.length * paramH + titleH + task.outputs.length * paramH; })
    .attr("style", "fill:" + d3.hsl(colors(2)).brighter(1.5) + ";stroke-width:1;stroke:rgb(32,32,32)")
    .attr("rx", 10)
    .attr("ry", 10);
	
var text = g.append("text")
    .attr("width", function(d) { return radius * 3; })
    .attr("style", "fill:rgb(32,32,32);")
    .attr("font-weight", "bold")
    .attr("text-anchor", "middle")
    .attr("alignment-baseline", "baseline")
    .attr("x", radius * 3/ 2)
    .attr("y", radius / 2)
    .attr("text-overflow", "ellipsis")
    .text(function(d) { return d.label; });

var outputContainer = g.append("g")
	.attr("transform", function(d) { return "translate(0," + titleH + ")"});
	
var inputContainer = g.append("g")
	.attr("transform", 
	function(d) {
		var task = find(tasks, d.ref);
		return "translate(0, " + (task.outputs.length * paramH + titleH) + ")"}
	);	
var inputGroup = inputContainer.selectAll(".input")
	.data(function(d, i) {
	var task = find(tasks, d.ref);
	return task.inputs; })
	.enter().append("g")
	.attr("class", "input")
	.attr("transform", function(d, i) { return "translate(0," + (i * paramH) + ")" });

var outputGroup = outputContainer.selectAll(".output")
	.data(function(d, i) { 
	var task = find(tasks, d.ref);
	return task.outputs; })
	.enter().append("g")
	.attr("class", "output")
	.attr("transform", function(d, i) { return "translate(" + radius * 3 + "," + (i * paramH) + ")" });
	
var inputCircle = inputGroup.append("circle")
	.attr("r", 5)
    .attr("cursor", "pointer")
	.attr("style", function(d, i) { return "fill:" + d3.hsl(getTypeColor(d.type)).brighter(1.1) + ";stroke-width:1;stroke:rgb(32,32,32)";});
	
var inputText = inputGroup.append("text")
	.text(function(d) { return d.id; })
	.attr("x", 10)	
    .attr("text-anchor", "start")
    .attr("alignment-baseline", "middle")
	.attr("style", "font-size:12;");
	
var outputCircle = outputGroup.append("circle")
	.attr("r", 5)
    .attr("cursor", "pointer")
	.attr("style", function(d, i) { return "fill:" + d3.hsl(getTypeColor(d.type)).brighter(1.1) + ";stroke-width:1;stroke:rgb(32,32,32)";});;

var outputText = outputGroup.append("text")
	.text(function(d) { return d.id; })
	.attr("x", -10)	
    .attr("text-anchor", "end ")
    .attr("alignment-baseline", "middle")
	.attr("style", "font-size:12;");
	
function dragmove(d) {
	d.x = d3.event.x;
	d.y = d3.event.y;
	d3.select(this)
		.attr("transform", "translate(" + d.x + "," + d.y + ")");
}

 function zoom() {
        node.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
    }


    // define the zoomListener which calls the zoom function on the "zoom" event constrained within the scaleExtents
    var zoomListener = d3.behavior.zoom().scaleExtent([0.1, 3]).on("zoom", zoom);
//base.call(zoomListener);
</script>